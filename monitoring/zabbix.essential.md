---
author: Artem Zhivushko
title: zabbix.essential
create: 2024-03-27 03:56:33
tags:
  - ZeroToHero
  - DevSecOps
  - zabbix
---

# Zabbix

**Zabbix** — распределенная система мониторинга, состоящая из четырех основных компонентов:

1. **Zabbix-сервер.** Ядро системы мониторинга. Компонент отвечает за визуализацию, агрегацию и аналитику данных, оповещения, управление распределенными компонентами (прокси и агентами). В качестве веб-сервера вендор позволяет использовать Apache или Nginx.
2. **Zabbix-прокси.** Этот компонент отвечает за управление Zabbix-агентами. Использование прокси необязательно, но позволяет снизить нагрузку на Zabbix-сервер за счет переноса с него функций управления агентами и предобработки данных (этот функционал появился в пятой версии Zabbix).
3. **Zabbix-агент.** Агент — конечный компонент инфраструктуры мониторинга. Выполняет сбор и отправку данных о производительности на Zabbix-прокси или Zabbix-сервер.
4. **База данных Zabbix.** Хранилище метрик производительности. Вендор поддерживает реляционные базы данных: MySQL, PostgreSQL, SQL Server, Oracle. Обращаем внимание, что с версии 5.0 прекращена поддержка базы данных IBM DB2.

## Setup Zabbix server in Alma Linux

### устанавливаем и настраиваем PostreSQL (можно и MySQL)

```bash
# установка RPM репозитория 
sudo dnf install -y https://download.postgresql.org/pub/repos/yum/reporpms/EL-9-x86_64/pgdg-redhat-repo-latest.noarch.rpm

# отключение встроенного модуля PostgreSQL
sudo dnf -qy module disable postgresql

# установка PostgreSQL
sudo dnf install -y postgresql16-server

# инициализация базы данных и включение автоматического запуска
sudo /usr/pgsql-16/bin/postgresql-16-setup initdb
sudo systemctl enable postgresql-16
sudo systemctl start postgresql-16
```

### устанавливаем Nginx (можно и Apache)

```bash
sudo dnf install -y nginx

# открываем порты для доступа к морде Zabbix
sudo firewall-cmd --zone=public --permanent --add-service=https
sudo firewall-cmd --zone=public --permanent --add-service=http
sudo firewall-cmd --reload
```

### устанавливаем и настраиваем Zabbix

> При использовании репозитория EPEL, необходимо исключить поставляемые с ним пакеты Zabbix. Редактируем файл `/etc/yum.repos.d/epel.repo` и добавте следующую директиву.
>> ```ini
>> [epel]
>> ...
>> excludepkgs=zabbix*
>> ```

```bash
sudo rpm -Uvh https://repo.zabbix.com/zabbix/6.4/rhel/9/x86_64/zabbix-release-6.4-1.el9.noarch.rpm
sudo dnf clean all

# установка Zabbix сервера, веб-интерфейса и агента
sudo dnf install zabbix-server-pgsql zabbix-web-pgsql zabbix-nginx-conf zabbix-sql-scripts zabbix-selinux-policy zabbix-agent

# создание базы данных
sudo -u postgres createuser --pwprompt zabbix
sudo -u postgres createdb -O zabbix zabbix

## на хосте Zabbix сервера импорт начальной схемы и данных
## необходимо ввести недавно созданный пароль от DB
sudo zcat /usr/share/zabbix-sql-scripts/postgresql/server.sql.gz | sudo -u zabbix psql zabbix
```

#### настройка базы данных для Zabbix сервера

Отредактировать файл `/etc/zabbix/zabbix_server.conf`

```ini
DBPassword=password
```

```bash
sudo nano -l /etc/zabbix/zabbix_server.conf
```

#### настройка PHP для веб-интерфейса
Отредактировать файл `/etc/nginx/conf.d/zabbix.conf` раскомментировать и настроить директивы ***'listen'*** и ***'server_name'***.

```ini
# listen 8080;
# server_name example.com;
```

```bash
sudo nano -l /etc/nginx/conf.d/zabbix.conf
```

```bash
# запуск процессов Zabbix сервера и агента
sudo systemctl restart zabbix-server zabbix-agent nginx php-fpm
sudo systemctl enable zabbix-server zabbix-agent nginx php-fpm

# можно пробовать открывать Zabbix UI web page (стандартный логин и пароль от морды l: Admin, p: zabbix)
```

#### настройка SSL

```bash
mkdir -p /etc/ssl/certs/private/
chmod 0750 /etc/ssl/certs/private

openssl req -new -nodes -keyout /etc/ssl/certs/private/zabbix.key -x509 -days 365 -out /etc/ssl/certs/zabbix.crt -subj "/C=XX/ST=XX/L=XX/0=XX/OU=XX/CN=XX/emailAddress=X@X.1an"

chmod 0400 /etc/ssl/certs/zabbix.crt
chmod 0400 /etc/ssl/certs/private/zabbix.key

mv /etc/nginx/conf.d/zabbix.conf /etc/nginx/conf.d/zabbix-ssl.conf
```

Edit SSL:

```ini
listen 443 ssl default_server;
server _name;
ssl on;
ssl_certificate /etc/ssl/certs/zabbix.crt;
ssl_certificate_key /etc/ssl/private/zabbix.key;
```

Create new .conf for redirect:

```bash
nano /etc/nginx/conf.d/zabbix.conf
```

```ini
server {
	listen 80;
	return 301 https://$host$request_uri?;
}
```

```bash
systemctl restart nginx
systemctl status nginx
```

## Setup Zabbix agent

### Apache

```bash
# с помощью команды узнаем имя процесса
sudo systemctl status apache2

# с помощью команды узнаем на каком порту работает
ss -lpn | grep apache
# или
ss -lpn | grep httpd
```

#### отредактировать файл status.conf:

```bash
# ls -alR /etc/apache2/ | grep status
status.conf
```

В блоке /server-status укажите IP, для которого будет доступна статистика, как 127.0.0.1/32:

```ini
#
# Allow server status reports generated by mod_status,
# with the URL of http://servername/server-status
#
# see https://httpd.apache.org/docs/2.4/mod/mod_status.html
#
<IfModule mod_status.c>
        <Location /server-status>
                SetHandler server-status
                Require host localhost
                Require ip 127.0.0.1/32
                <IfModule !mod_access_compat.c>
                        Require local
                        Require ip 127.0.0.1/32
                </IfModule>
                <IfModule mod_access_compat.c>
                        Order deny,allow
                        Deny from all
                        Allow from localhost
                </IfModule>
        </Location>
</IfModule>
```

После редактирования проверить конфигурацию Apache. Если ошибок нет, подключить модуль status_module и перезапустить сервис:

```bash
apachectl -t
a2enmod status
systemctl restart apache2
systemctl status apache2
```

Теперь в консоли сервера введите такую команду:

```bash
curl http://127.0.0.1:80/server-status?auto # Apache работает на порту 80
```

```bash
# результат вывода детальной информации о состоянии сервиса Apache на момент ввода команды на консоли:

127.0.0.1
ServerVersion: Apache/2.4.51 (Linux/SUSE) OpenSSL/1.1.1l-fips PHP/8.1.24
ServerMPM: prefork
Server Built: 2023-10-30 11:36:45.000000000 +0000
CurrentTime: Tuesday, 05-Dec-2023 15:00:11 +03
RestartTime: Tuesday, 05-Dec-2023 15:00:01 +03
ParentServerConfigGeneration: 1
ParentServerMPMGeneration: 0
ServerUptimeSeconds: 9
ServerUptime: 9 seconds
Load1: 0.01
Load5: 0.02
Load15: 0.00
BusyWorkers: 1
IdleWorkers: 4
Scoreboard: __W__.................................................................................................................................................
TLSSessionCacheStatus
CacheType: SHMCB
CacheSharedMemory: 512000
CacheCurrentEntries: 2
CacheSubcaches: 32
CacheIndexesPerSubcaches: 88
CacheTimeLeftOldestAvg: 295
CacheTimeLeftOldestMin: 295
CacheTimeLeftOldestMax: 295
CacheIndexUsage: 0%
CacheUsage: 0%
CacheStoreCount: 2
CacheReplaceCount: 0
CacheExpireCount: 0
CacheDiscardCount: 0
CacheRetrieveHitCount: 0
CacheRetrieveMissCount: 0
CacheRemoveHitCount: 0
CacheRemoveMissCount: 0
```

При настройке макросов необходимо отредактировать значения `{$APACHE.PROCESS_NAME}` и `{$APACHE.STATUS.PORT}`.

### MySQL

#### Настроить пользователя MySQL на Zabbix

```sql
CREATE USER 'zabbix-agent'@'%' IDENTIFIED BY 'Agent-Password';  
GRANT USAGE ON *.* TO 'zabbix-agent'@'%';  
FLUSH PRIVILEGES;  
quit;
```

```bash
sudo systemctl restart zabbix-agent2
systemctl status zabbix-agent2
```

При настройке макросов необходимо отредактировать значения `{$MYSQL.USER}`, `{$MYSQL.PASSWORD}` и `{$MYSQL.DSN}`. Соответственно логин и пароль пользователя zabbix-agent в БД, а также хост и порт на котором работает БД.

### Health check

Создаем свой Template, в нем новый Web scenarios.

В вкладке Scenario:

```ini
Name = URL health check
Update interval = 1m
Attempts = 3
```

В вкладке Steps, нажать add:

```ini
Name = Health check
URL = https://{$WEB.URL}
Timeout = 15s

# можно ориентироваться по наличию строки на странице
Required string = 

# или же по коду ответа
Required status codes = 200
```

